box: phusion/passenger-ruby22
services:
  - id: postgres
    env:
      POSTGRES_PASSWORD: ourlittlesecret
      POSTGRES_USER: myuser  # optional
build:
  steps:
    - bundle-install
    - rails-database-yml
    - script:
        name: Set up db
        code: bundle exec rake db:drop db:create db:schema:load RAILS_ENV=test
    - script:
        name: rspec
        code: bundle exec rspec RAILS_ENV=test
deploy:
  steps:
    - heroku-deploy:
        key-name: HEROKU_DEPLOY_KEY
        run: rake db:migrate
  after-steps:
    - wantedly/pretty-slack-notify:
        webhook_url: $SLACK_WEBHOOK_URL
