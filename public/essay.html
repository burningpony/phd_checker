<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>

    <script type='text/javascript'>
//<![CDATA[
    var gaJsHost = (("https:" == document.location.protocol) ? "https://" : "http://");
    document.write(unescape("%3Cscript src='" + gaJsHost + "ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js' type='text/javascript'%3E%3C/script%3E"));
    //]]>
    </script>
    <link rel="stylesheet" href="https://github.com/joshuaclayton/blueprint-css/raw/master/blueprint/screen.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <link rel="stylesheet" href="https://github.com/joshuaclayton/blueprint-css/raw/master/blueprint/plugins/fancy-type/screen.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <script type="text/javascript" src="fancybox/jquery.fancybox-1.3.4.pack.js"></script>
  	<link rel="stylesheet" type="text/css" href="fancybox/jquery.fancybox-1.3.4.css" media="screen" />
    <style type="text/css">

    .unmodified input{
    background-color: cyan;
    border: none;
    }
    .modified input{
    background-color: red;
    border: none;
    }

    /* styles for string diff */
    del {
    background: #FFE6E6;
    }
    ins {
    background: #E6FFE6;
    }

    /* classes for result */
    .result ol li{
    padding: 5px;
    }
    .status {
    padding-right: 10px;
    width: 80px;
    }

    .state_correct {
    background-color: yellow;
    }

    .state_modified {
    background-color: cyan;
    }

    .state_reverted {
    background-color: gray;
    }

    .state_no_change {
    background-color: tan;
    }

    </style>
    <title></title>
  </head>
  <body>
    <div class="container">
      <div class="participant">
        <span>Enter Participant Number</span> <input type="text" id="number"> <input type="button" value="continue" class="continue">
      </div>
    
      <div class="essay_groups span-24 last">
        <!-- create a div like this for each essay -->
        
        
        
        
        
        
        
            <div id="stat_window"></div><!-- the body of the essay goes here -->      
            <div id="user">
            <h2>
              Participant <span></span>
            </h2>
            </div>
        <div id="essay-1" class="essay">

          <div class="essay_body">
              <h3>
                Essay 1
              </h3>
              <p>
                With the advent of the so-called "slow-food" movement, more and more people are rediscovering the joy of preparing food. Many slow-food enthusiasts are even bringing back the forgotten art of bread baking. With a bread machine or without, these individuals are providing <span id="Iamunique" class="correctme" rel="ther'er" >there</span> friends and <span id="somethingelse" class="correctme">family's</span> with delicious, home-baked bread that is healthful and fun to make.
              </p>
              <p>
                Making a loaf of bread is fun and engaging, but it is also a process that involves careful preparation, lots of patience, and a few spare hours of free time. Before the dough can be kneaded, it first needs to be mixed together. Start with quality ingredients like organic whole wheat flour, yeast, and water. Whole wheat flour will take more time to knead, but the result will be a more flavorful and healthier loaf of break.
              </p>
              <p>
                Once you've measured out the ingredients, <span class="correctme">your</span> ready to begin. Measure out the <span class="correctme">flower</span> and place it in a large steel mixing bowl. Place a small portion of warm water in a dish and sprinkle the yeast powder on top of it. Allow the yeast and water to sit for a while. All of the ingredients, <span class="correctme">accept</span> for the flour, need time to warm up before use. Feel free to store your ingredients in the refrigerator to keep them fresh. After the yeast has warmed up, mix it in to the flour. Stir vigorously to form a gummy paste. Don't let it get <span class="correctme">to</span> thick or <span class="correctme">your</span> going to have a mess on your hands. Add the water in small portions, being careful not to spill it. Make sure all the ingredients are incorporated into the thick dough before you begin to knead it. The dough should be kneaded until it becomes stretchy and smooth. Form the dough into a ball and let it sit until it loses some of <span class="correctme">it's</span> tightness. Once it has rested about ten minutes, cover it with a damp towel to rise. Be sure to set it in a warm location, away from drafts and temperature changes. It's important to have a controlled environment to ensure even rising.
              </p>
              <p>
                After about an hour and a half, your dough should <span class="correctme">of</span> ballooned to at least double its original size. At this point, your bread is ready to bake, but if you want a tastier loaf with big pockets of air in the crumb, let the dough rise a second time. Deflate the dough by pressing down and releasing the air from the dough. Then lift the dough and tuck the edges under neath to form a tight ball. Be careful not to tear the gluten skin that has formed or else the gases will escape and <span class="correctme">assure</span> that your second rise is pointless. Set the deflated, now tight ball of dough covered in the same warm location away from drafts. The second rise time will be shorter, as the yeast microbes will have multiplied several times. After about forty-five minutes, your dough will be ready for shaping.
              </p>
            </div><input type="button" value="continue" class="continue">
          </div>

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        <div class="correction">
          <h2>
            Participant
          </h2><span>Here's how you did (Also emailed to ellie)</span> <span class="result">Way to go</span> <input type="button" value="continue" class="continue">
        </div><script type="text/javascript">
// hide panels
        $(".participant").show();
        $(".essay").hide();
        $(".correction").hide();    
        setInterval( "updateStats()", 60000 );
        $(document).ready(function(){

        function generate_box(span) {
        span.className = "correctme unmodified";

        console.log(span);
        var original_text = $(span).html();

        //clear it
        $(span).html("");

        var input = document.createElement("input")
        input.type     = "text";
        input.value    = original_text;
        input.size     = input.value.length*1.2;

        var correct_answer = input.getAttribute('rel');

        input.state = function() {
        /*
        Given a span like:
        <span class='correctme' rel='correct string'>original string<\/span>

        Tells us whether the string modified by the user is
        - correct
        - modified, but reverted to the original
        - no change (un touched at all by the user)
        - modifies, and returns difference
        */
        var current_value = input.value;

        if(input.modified) {
        if(current_value == correct_answer) {
        return { status: "correct",  msg: correct_answer, style_class: "state_correct" }
        }
        else if(current_value == original_text) {
        return {status: "incorrect - reverted to original", msg: "modified but returned to normal", style_class: "state_reverted"}
        }
        else {
        // find the differnce between original and difference
        // using the diffString Algorithm
        var difference = diffString(original_text, current_value);

        // modified, return difference
        return {status: "incorrect - modified", msg: difference, style_class: "state_modified"} 
        }

        }else {
        return { status: "incorrect - no change", msg: current_value, style_class: "state_no_change"};
        }
        }

        var change_function = function() {

        // remember that the field was modified
        input.modified = true;

        // timeout 10ms so we can read the input value for changes
        setTimeout(function() {
        span.className = "correctme modified";

        if(input.value == original_text) {
        span.className = "correctme unmodified";

        }                        

        },10);
        }

        // handle change events
        input.onkeyup   = change_function;
        input.onchange  = change_function;


        span.appendChild(input);

        }

        $(".essay span.correctme").each(function(){
        generate_box(this);
        });

        $("span.correctme input").change(function() {
        var correct_me_id = $(this).closest("span").attr('id');
        var corrected = $(this).val()
        var uncorrected = $(this).closest("span").attr('rel');
        var essay = $(this).closest("div").attr("id");

        send_correction($(".participant #number").val(),essay,correct_me_id, uncorrected, corrected );
        });


        $(".participant .continue").click(function(){
        $(".essay").show();
        $(".participant").hide();
        $("#user h2 span").html( $(".participant #number").val());
        });

        $(".essay .continue").click(function(){
        $(".essay").hide();
        $(".correction").show();                


        // clear it
        $(".correction .result").html("");

        // show the fields entered
        var list =  document.createElement("ol");

        $(".essay span.correctme input").each(function(){

        // Creates a report of the differences and corrected items

        var list_item =  document.createElement("li");
        var result_string = "";
        var result = this.state();

        result_string = "<span class='status " + result.style_class + "'>" + result.status + "<\/span><span class='message'>" + result.msg + "<\/span>"; 

        $(list_item).html( result_string );
        list.appendChild(list_item);

        // You could imagine saving the results here
        });                

        $(".correction .result")[0].appendChild(list);
        });  


        $(".correction .continue").click(function(){

        $(".correction").hide();
        $(".participant").show();                
        });            

        });
        // sends it all to the back end.  user is create or found by participant, locations are set by the essay ID then the field ID ,  what the text was supposed to be what it was sent and if that is right. 
        function send_correction (participant,essay, id, uncorrected, corrected, correct ) {
        var params = { "participant_id":participant, "response":{"essay":essay,"id":id, "uncorrected":uncorrected , "corrected":corrected , "correct":correct } };
        var str = jQuery.param(params);

        $.ajax({
        type: 'POST',
        url: "responses",
        data: str
        });
        }

        function updateStats () {
          $.fancybox({
              "users/stats" : responseText
          });
        }
        </script> 
        <script type="text/javascript">
/*
        * Javascript Diff Algorithm
        *  By John Resig (http://ejohn.org/)
        *  Modified by Chu Alan "sprite"
        *
        * Released under the MIT license.
        *
        * More Info:
        *  http://ejohn.org/projects/javascript-diff-algorithm/
        */

        function escape(s) {
        var n = s;
        n = n.replace(/&/g, "&amp;");
        n = n.replace(/<\/g, "&lt;");
        n = n.replace(/>/g, "&gt;");
        n = n.replace(/"/g, "&quot;");

        return n;
        }

        function diffString( o, n ) {
        o = o.replace(/\s+$/, '');
        n = n.replace(/\s+$/, '');

        var out = diff(o == "" ? [] : o.split(/\s+/), n == "" ? [] : n.split(/\s+/) );
        var str = "";

        var oSpace = o.match(/\s+/g);
        if (oSpace == null) {
        oSpace = ["\n"];
        } else {
        oSpace.push("\n");
        }
        var nSpace = n.match(/\s+/g);
        if (nSpace == null) {
        nSpace = ["\n"];
        } else {
        nSpace.push("\n");
        }

        if (out.n.length == 0) {
        for (var i = 0; i < out.o.length; i++) {
        str += '<del>' + escape(out.o[i]) + oSpace[i] + "<\/del>";
        }
        } else {
        if (out.n[0].text == null) {
        for (n = 0; n < out.o.length && out.o[n].text == null; n++) {
        str += '<del>' + escape(out.o[n]) + oSpace[n] + "<\/del>";
        }
        }

        for ( var i = 0; i < out.n.length; i++ ) {
        if (out.n[i].text == null) {
        str += '<ins>' + escape(out.n[i]) + nSpace[i] + "<\/ins>";
        } else {
        var pre = "";

        for (n = out.n[i].row + 1; n < out.o.length && out.o[n].text == null; n++ ) {
          pre += '<del>' + escape(out.o[n]) + oSpace[n] + "<\/del>";
        }
        str += " " + out.n[i].text + nSpace[i] + pre;
        }
        }
        }

        return str;
        }

        function randomColor() {
        return "rgb(" + (Math.random() * 100) + "%, " + 
        (Math.random() * 100) + "%, " + 
        (Math.random() * 100) + "%)";
        }
        function diffString2( o, n ) {
        o = o.replace(/\s+$/, '');
        n = n.replace(/\s+$/, '');

        var out = diff(o == "" ? [] : o.split(/\s+/), n == "" ? [] : n.split(/\s+/) );

        var oSpace = o.match(/\s+/g);
        if (oSpace == null) {
        oSpace = ["\n"];
        } else {
        oSpace.push("\n");
        }
        var nSpace = n.match(/\s+/g);
        if (nSpace == null) {
        nSpace = ["\n"];
        } else {
        nSpace.push("\n");
        }

        var os = "";
        var colors = new Array();
        for (var i = 0; i < out.o.length; i++) {
        colors[i] = randomColor();

        if (out.o[i].text != null) {
        os += '<span style="background-color: ' +colors[i]+ '">' + 
        escape(out.o[i].text) + oSpace[i] + "<\/span>";
        } else {
        os += "<del>" + escape(out.o[i]) + oSpace[i] + "<\/del>";
        }
        }

        var ns = "";
        for (var i = 0; i < out.n.length; i++) {
        if (out.n[i].text != null) {
        ns += '<span style="background-color: ' +colors[out.n[i].row]+ '">' + 
        escape(out.n[i].text) + nSpace[i] + "<\/span>";
        } else {
        ns += "<ins>" + escape(out.n[i]) + nSpace[i] + "<\/ins>";
        }
        }

        return { o : os , n : ns };
        }

        function diff( o, n ) {
        var ns = new Object();
        var os = new Object();

        for ( var i = 0; i < n.length; i++ ) {
        if ( ns[ n[i] ] == null )
        ns[ n[i] ] = { rows: new Array(), o: null };
        ns[ n[i] ].rows.push( i );
        }

        for ( var i = 0; i < o.length; i++ ) {
        if ( os[ o[i] ] == null )
        os[ o[i] ] = { rows: new Array(), n: null };
        os[ o[i] ].rows.push( i );
        }

        for ( var i in ns ) {
        if ( ns[i].rows.length == 1 && typeof(os[i]) != "undefined" && os[i].rows.length == 1 ) {
        n[ ns[i].rows[0] ] = { text: n[ ns[i].rows[0] ], row: os[i].rows[0] };
        o[ os[i].rows[0] ] = { text: o[ os[i].rows[0] ], row: ns[i].rows[0] };
        }
        }

        for ( var i = 0; i < n.length - 1; i++ ) {
        if ( n[i].text != null && n[i+1].text == null && n[i].row + 1 < o.length && o[ n[i].row + 1 ].text == null && 
        n[i+1] == o[ n[i].row + 1 ] ) {
        n[i+1] = { text: n[i+1], row: n[i].row + 1 };
        o[n[i].row+1] = { text: o[n[i].row+1], row: i + 1 };
        }
        }

        for ( var i = n.length - 1; i > 0; i-- ) {
        if ( n[i].text != null && n[i-1].text == null && n[i].row > 0 && o[ n[i].row - 1 ].text == null && 
        n[i-1] == o[ n[i].row - 1 ] ) {
          n[i-1] = { text: n[i-1], row: n[i].row - 1 };
          o[n[i].row-1] = { text: o[n[i].row-1], row: i - 1 };
        }
        }

        return { o: o, n: n };
        }
        </script>
      </div>
    </div>
  </body>
</html>
